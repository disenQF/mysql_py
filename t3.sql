drop table if exists person;
drop table if exists sales;
drop table if exists cost;

create table person(id int,name varchar(50));
create table sales(pid int ,sd date, sm float);
create table cost(pid int,cd timestamp,cm float);


insert person(id,name)
values(1,'李梦琪'),(2,'李明'),(3,'吴鹏'),(4,'刘洋'),(5,'张飞飞');

insert sales 
values(1,'2018-02-12 10:25:30',2000),(1,'2016-02-12 11:20:35',3000),
       (1,'2018-02-15 09:11:24',12000),(1,'2018-02-15 14:18:20',9000),
       (1,'2018-02-17 10:25:30',2400),(1,'2016-02-17 11:20:35',13000),
       (1,'2018-02-17 12:11:24',12000),(1,'2018-02-17 13:22:20',19000),
       (2,'2018-02-15 09:11:24',5000),(2,'2018-02-15 14:28:20',8000),
       (2,'2018-02-17 10:25:30',2400),(2,'2016-02-17 11:20:35',13000),
       (2,'2018-02-17 12:11:24',12000),(2,'2018-02-17 13:22:20',11000),
       (3,'2018-02-15 09:19:24',5000),(3,'2018-02-15 15:22:28',14000),
       (3,'2018-02-17 10:25:30',24000),(3,'2016-02-17 13:20:35',11000),
       (4,'2018-02-17 12:11:24',18000),(4,'2018-02-17 13:22:20',19000),
       (4,'2018-02-15 09:11:24',19000),(4,'2018-02-15 14:29:20',9300),
       (5,'2018-02-17 10:25:30',2000),(5,'2016-02-17 11:25:35',2800),
       (5,'2018-02-17 12:11:24',50000),(5,'2018-02-17 17:22:20',8100);

insert cost
values(1,'2018-02-12 10:25:30',1000),(1,'2016-02-12 11:20:35',500),
       (1,'2018-02-15 09:11:24',1500),(1,'2018-02-15 14:18:20',900),
       (1,'2018-02-17 10:25:30',890),(1,'2016-02-17 11:20:35',1300),
       (1,'2018-02-17 12:11:24',600),(1,'2018-02-17 13:22:20',4900),
       (2,'2018-02-15 09:11:24',380),(2,'2018-02-15 14:28:20',800),
       (2,'2018-02-17 10:25:30',400),(2,'2016-02-17 11:20:35',1300),
       (2,'2018-02-17 12:11:24',1250),(2,'2018-02-17 13:22:20',800),
       (3,'2018-02-15 09:19:24',950),(3,'2018-02-15 15:22:28',10000),
       (3,'2018-02-17 10:25:30',2400),(3,'2016-02-17 13:20:35',1000),
       (4,'2018-02-17 12:11:24',11000),(4,'2018-02-17 13:22:20',400),
       (4,'2018-02-15 09:11:24',1200),(4,'2018-02-15 14:29:20',300),
       (5,'2018-02-17 10:25:30',900),(5,'2016-02-17 11:25:35',800),
       (5,'2018-02-17 12:11:24',3000),(5,'2018-02-17 17:22:20',100);

drop view if exists profit_view;
create view profit_view
as
select p.name , sum(s.sm) sm , sum(c.cm) cm,
       round((sum(s.sm)-sum(c.cm))/sum(s.sm),4)*100  as profit
from person p
join sales s on p.id=s.pid
join cost c on p.id=c.pid
group by p.name;

select * from profit_view;

select a.name,a.sd,a.sm,b.cd, b.cm
 from	
 ( select p.name ,date(s.sd) sd ,sum(s.sm) sm  
   from person p
   join sales s on p.id=s.pid
   group by p.name,date(s.sd)) a
join 
 ( select  p.name ,date(c.cd) cd, sum(c.cm) cm
   from person p
   join cost c on p.id=c.pid
   group by p.name,date(c.cd) 
  ) b
on a.name = b.name and a.sd=b.cd
order by a.sd
